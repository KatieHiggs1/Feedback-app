<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>
	  BW
	</title>
	<link rel="stylesheet"
        type="text/css"
         href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" />
  </head>
  <body style="background-color:white;">

    <div class="container" align="center">
        <div id="no-script"class="bg-info">
            This application needs JavaScript enabled in your browser!
        </div>
        <div id="id_contextdump"></div>
        <img src="https://pbs.twimg.com/profile_images/502720280708399104/nR7ZciFf.jpeg" alt="Betaworks logo" style="width:200px;height:200px;">
        <h1>Feedback App</h1>
        <p>Please type something in the textbox below to initiate conversation with Watson <br /> and press the 'send' button when you are ready to submit your response.</p>
        <div id=id_botchathistory style="background-color:white; padding-top:10px;">
	    </div>

	  <div align="center" style="background-color:white">
	      <form style="padding-top: 10px;">
            <label for="id_chattext">Enter response here: </label>
            <input type="text" name="chattext" id="id_chattext" style="width: 500px; height: 50px;">
            <br/><br/>
	      <button id="id_enter" type="button" button onclick="javascript:onChatClick()">Send</button>
	      <button onclick="javascript:onChatFinish()">Finish</button>
	      </form>
	  </div>
    </div>
    <script type="text/javascript" src="https://code.jquery.com/jquery-2.1.4.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>

    <script type="text/javascript">

        $(document).ready(function() {
            javascriptCheck();
            $('#id_contextdump').hide();
            enterbutton();
            invokeAjax ("Hello");
        });

        // if javascript is enabled on the browser then can
        // remove the warning message
        function javascriptCheck() {
            $('#no-script').remove();
        }

        function enterbutton(){
            $(function() {
                $("form input").keypress(function (e) {
                if ((e.which && e.which == 13) || (e.keyCode && e.keyCode == 13)) {
                     $('#id_enter').click();
                     return false;
                } else {
                return true;
                }
             });
            });
        }

        function createNewDiv(who, message) {
            console.log('002-001');
            var txt = who + ' : ' + message;
            return $('<div></div>').text(txt);
        }

        function chat(person, txt) {
            $('#id_botchathistory').append(createNewDiv(person, txt));
        }

        function processOK(response) {
            console.log('003-001');
            console.log(response);
            console.log(response.botresponse.messageout);
            console.log(response.botresponse.messageout.output.text);
            console.log(response.botresponse.messageout.context);
            chat('Watson', response.botresponse.messageout.output.text);
            $('#id_contextdump').data('convContext', response.botresponse.messageout.context);
        }

        function processNotOK() {
            chat('Error', 'Error whilst attempting to talk to Watson');
        }

        function invokeAjax(message) {
            var contextdata = $('#id_contextdump').data('convContext');
            console.log('checking stashed context data');
            console.log(contextdata);


            //var ajaxData = "msgdata=" + message;
            var ajaxData = {};
                ajaxData.msgdata = message;
                if (contextdata) {
                ajaxData.context = contextdata;
            }

            $.ajax({
                    type: 'POST',
                    url: 'botchat',
                    data: ajaxData,
                    success: processOK,
                    error: processNotOK
                });
            }

        // User has entered some text.
        function onChatClick() {
            console.log('001-001');
            var txt = $('#id_chattext').val();
            chat('You', txt);
            invokeAjax(txt);
            console.log('001-002');
            $('#id_chattext').val('');
        }

        // User has entered some text.
        function onChatFinish() {
            console.log('hello');
        }


        //invoke ajax call on page ready
        $(document).ready(function(){
        $.ajax({
            type: 'POST',
            url: 'botchat',
            success: processOK,
            error: processNotOK
            });
        });

    </script>
  </body>
</html>
