<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>
	  BW
	</title>
	<link rel="stylesheet"
        type="text/css"
         href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" />
         href="https://github.com/KatieHiggs1/BWFeedback.git" />
  </head>

  <div class="container" align="center" id="form-main">
    <div id="form-div">
      <form class="form" id="form1">
          This application needs JavaScript enabled in your browser!
      </div>

      <div class="logo">
        <img src="https://pbs.twimg.com/profile_images/502720280708399104/nR7ZciFf.jpeg" alt="Betaworks logo">
      </div>

      <h1>Feedback App</h1>
      <div id=id_botchathistory style="background-color:white; padding-top:10px;">
      </div>

	  <div class="text">
            <label for="id_chattext">Enter response here: </label>
            <input type="text" name="chattext" id="id_chattext">
            <br/><br/>
    </div>

          <div class="submit">
  	         <button id="id_enter" type="button" id="button-blue" button onclick="javascript:onChatClick()">Send</button>
             <div class="ease"></div>
          </div>
        </form>
	  </div>

    <script type="text/javascript" src="https://code.jquery.com/jquery-2.1.4.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>

    <script type="text/javascript">

        $(document).ready(function() {
            javascriptCheck();
            $('#id_contextdump').hide();
            enterbutton();
            invokeAjax ("Hello");
        });

        // if javascript is enabled on the browser then can
        // remove the warning message
        function javascriptCheck() {
            $('#no-script').remove();
        }

        function enterbutton(){
            $(function() {
                $("form input").keypress(function (e) {
                if ((e.which && e.which == 13) || (e.keyCode && e.keyCode == 13)) {
                     $('#id_enter').click();
                     return false;
                } else {
                return true;
                }
             });
            });
        }

        function createNewDiv(who, message) {
            console.log('002-001');
            var txt = who + ' : ' + message;
            return $('<div></div>').text(txt);
        }

        function chat(person, txt) {
            $('#id_botchathistory').append(createNewDiv(person, txt));
        }

        function processOK(response) {
            console.log('003-001');
            console.log(response);
            console.log(response.botresponse.messageout);
            console.log(response.botresponse.messageout.output.text);
            console.log(response.botresponse.messageout.context);
            chat('Watson', response.botresponse.messageout.output.text);
            $('#id_contextdump').data('convContext', response.botresponse.messageout.context);
        }

        function processNotOK() {
            chat('Error', 'Error whilst attempting to talk to Watson');
        }

        function invokeAjax(message) {
            var contextdata = $('#id_contextdump').data('convContext');
            console.log('checking stashed context data');
            console.log(contextdata);


            //var ajaxData = "msgdata=" + message;
            var ajaxData = {};
                ajaxData.msgdata = message;
                if (contextdata) {
                ajaxData.context = contextdata;
            }

            $.ajax({
                    type: 'POST',
                    url: 'botchat',
                    data: ajaxData,
                    success: processOK,
                    error: processNotOK
                });
            }

        // User has entered some text.
        function onChatClick() {
            console.log('001-001');
            var txt = $('#id_chattext').val();
            chat('You', txt);
            invokeAjax(txt);
            console.log('001-002');
            $('#id_chattext').val('');
        }

        //invoke ajax call on page ready
        $(document).ready(function(){
        $.ajax({
            type: 'POST',
            url: 'botchat',
            success: processOK,
            error: processNotOK
            });
        });

    </script>
  </body>
</html>
